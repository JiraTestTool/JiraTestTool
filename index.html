<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <title>JiraTestTool</title>
    <script src="node_modules/handsontable/dist/handsontable.full.min.js"></script>
    <link href="node_modules/handsontable/dist/handsontable.full.min.css" rel="stylesheet" media="screen">
    <link rel="stylesheet" href="./style.css">
  </head>
  <header class="header" id="myHeader">
    <h1>JiraTestTool</h1>
  </header>
  <body>

    <script>
      // You can also require other files to run in this process
      require('./renderer.js')
    </script>

    <!-- render process for Menu bar https://electronjs.org/docs/api/menu#render-process -->
    <script>
    const {remote} = require('electron')
    const {Menu, MenuItem} = remote

    const menu = new Menu()
    menu.append(new MenuItem({label: 'MenuItem1', click() { console.log('item 1 clicked') }}))
    menu.append(new MenuItem({type: 'separator'}))
    menu.append(new MenuItem({label: 'MenuItem2', type: 'checkbox', checked: true}))

    window.addEventListener('contextmenu', (e) => {
      e.preventDefault()
      menu.popup({window: remote.getCurrentWindow()})
    }, false)
    </script>


    <div class="login">
      username: <input id="userID" type="text" name="username"><br>
      password: <input id="passID" type="password" name="password"><br>
      <div id="loginStatusContainer"></div>
      <button value="login" onclick="login('userID','passID')">Login</button><br>
    </div>

    <br><br>

    <div class="after_login">

        <div class="issue">
          issue: <input id="issueKey" type="text" name="issue"><br>
          <div id="issueStatusContainer"></div>
          <button value="get test steps" onclick="getSteps('issueKey') ; getSteps('issueKey',{preSteps:true})">
            Get Steps
          </button>
          <br>
        </div>

        <div>
          <h2>Pre-Test Steps</h1>
          <input id="pre_step_search_field" type="search" placeholder="Search">
          <br><br>
          <div id="preStepSheet"></div>
          <br><br>
          <h2>Test Steps</h1>
          <input id="step_search_field" type="search" placeholder="Search">
          <br><br>
          <div id="stepSheet"></div>
          <script type="text/javascript">
            var stepHotData = [
              ["Step", "Description", "Expected", "Notes"],
              ["Step 1", "do stuff", "expect this", "remember this important thing"],
              ["Step 2", "do stuff", "expect this", ""],
              [,,,],
              [,,,],
              [,,,],
              [,,,],
              [,,,],
            ];
            var preStepHotData = [
              ["Step", "Description", "Expected", "Notes"],
              ["Precondition 1", "do stuff", "expect this", "remember this important thing"],
              ["Precondition 2", "do stuff", "expect this", ""],
              [,,,],
              [,,,],
              [,,,],
              [,,,],
              [,,,],
            ];

            var preStepSearchField = document.getElementById('pre_step_search_field');
            var preStepSheet = document.getElementById('preStepSheet');
            var stepSearchField = document.getElementById('step_search_field');
            var stepSheet = document.getElementById('stepSheet');

            stepHotStuff = {
              data: stepHotData,
              width: 800,
              rowHeaders: true,
              colHeaders: [
                 'Step',
                 'Description',
                 'Expected',
                 'Notes',
              ],
              colWidths: [60, 200, 200, 200],
              /* true by default */
              allowInsertRow: true, /* even without contextMenu, can paste to expand spreadsheet */
              allowRemoveRow: true,
              /* false by default */
              search: true,
              contextMenu: true,
              mergeCells: true,
              manualRowResize: true,
              manualColumnResize: true,
              wordWrap: true,
              //manualRowMove: true,
              //manualColumnMove: true,
              /* a way to enforce 4 columns Step/Desc/Expect/Notes */
              allowInsertColumn: false,
              allowRemoveColumn: false
            };

            preStepHotStuff = {
              data: preStepHotData,
              width: 800,
              rowHeaders: true,
              colHeaders: [
                 'Step',
                 'Description',
                 'Expected',
                 'Notes',
              ],
              colWidths: [60, 200, 200, 200],
              /* true by default */
              allowInsertRow: true, /* even without contextMenu, can paste to expand spreadsheet */
              allowRemoveRow: true,
              /* false by default */
              search: true,
              contextMenu: true,
              mergeCells: true,
              manualRowResize: true,
              manualColumnResize: true,
              wordWrap: true,
              //manualRowMove: true,
              //manualColumnMove: true,
              /* a way to enforce 4 columns Step/Desc/Expect/Notes */
              allowInsertColumn: false,
              allowRemoveColumn: false
            };

            var preStepHot = new Handsontable(preStepSheet, preStepHotStuff);
            var stepHot = new Handsontable(stepSheet, stepHotStuff);

            Handsontable.dom.addEvent(stepSearchField, 'keyup', function (event) {
              var search1 = stepHot.getPlugin('search');
              var queryResult1 = search1.query(this.value);

              console.log(queryResult1);
              stepHot.render();
            });

            Handsontable.dom.addEvent(preStepSearchField, 'keyup', function (event) {
              var search2 = preStepHot.getPlugin('search');
              var queryResult2 = search2.query(this.value);

              console.log(queryResult2);
              preStepHot.render();
            });

          </script>
        </div>

        <br><br>

        <div class="update">
          <div id="updateStatusContainer"></div>
          <input type="button" value="Send Test Steps to JIRA" onclick="editSteps('issueKey')">
          <input type="button" value="Send Pre-Test Steps to JIRA" onclick="editSteps('issueKey',{preSteps:true})">
        </div>

        <br><br>

    </div>
  </body>
  <footer>
    <script type="text/javascript">
        // gloabal variables
        process.env.NODE_TLS_REJECT_UNAUTHORIZED = '0';
        user = "";
        pass = "";
        jira = undefined;
        b64 = "";
        const loginStatus = document.querySelector('#loginStatusContainer');
        const issueStatus = document.querySelector('#issueStatusContainer');
        const updateStatus = document.querySelector('#updateStatusContainer');
        var isLoggedIn = false; /* set to true on successful login() and false helps getSteps how to prompt */
        var gotSteps = false; /* set to true on successful getSteps() and false helps editSteps know to not update on accident */

        var JiraClient = require('jira-connector');

        function login(idUserInput, idPassInput) {
          user = document.getElementById(idUserInput).value;
          pass = document.getElementById(idPassInput).value;
          b64 = btoa(user+":"+pass); user="";pass="";
          console.log("logging in...");
          jira = new JiraClient( {
              host: 'jira/jira',
              basic_auth: {
                base64: b64
              }
          });
          loginStatus.innerHTML = `<br>Logging in. Please wait...`;
          jira.myself.getMyself( {}, function(error, myself, response) {
            switch (response.statusCode) {
              case 200: // response.statusMessage: "OK"
                isLoggedIn = true;
                console.log(myself);
                console.log(response);
                loginStatus.innerHTML = `<br>Hello ${myself.displayName}!`;
                break;
              case 401: // response.statusMessage: "Unauthorized"
                isLoggedIn = false;
                console.log(error);
                console.log(response);
                loginStatus.innerHTML = `<br>Wrong username/password`;
                break;
              case 403: // response.statusMessage: "Forbidden"
                isLoggedIn = false;
                console.log(error);
                console.log(response);
                /* in the future check `response.headers.x-authentication-denied-reason`
                 * if it has "CAPTCHA_CHALLENGE"
                 * then use the information inside `response` to redirect to the CAPTCHA via the login-url & JSESSIONID
                 */
                loginStatus.innerHTML = `<br>Your account is locked.`
                    + `<br>Please contact to your administrator to unlock your account and/or do the CAPTCHA on https://${jira.host}`;
                break;
              default: // unexpected
                isLoggedIn = false;
                loginStatus.innerHTML = `<br>Unexpected response from jira. Please see the console for more information (CTRL+SHIFT+I)`;
                console.log(error);
                console.log(myself);
                console.log(response);
            }
          });
        }

        /*
        * "customfield_10400" seems to be the "Pre-Test Requirements:" field
        * "customfield_10403" seems to be the "Test Execution Steps and Expected Results:" field
        * "customfield_10405" seems to be the "Description of Test Case/Suite:" field
        * "customfield_11360" seems to be the "Parent Name:" field
        * "customfield_10395" seems to be the "User Type:" field
        * "assignee" "reporter" are all fields of their own
        * "customfield_13060" seems to be the "Scripter/s" field
        * "customfield_14868" seems to be the audit assignee field
        * "watches" seems to have properties "isWatching" if the current user is watching, along with a link to the watchers and the "watchCount"
        */

        var arr;

        function getSteps(idIssueKey, opts={}) {
          var key = document.getElementById(idIssueKey).value;
          var fieldIdStr = 'customfield_10403'; // "customfield_10403" seems to be the "Test Execution Steps and Expected Results:" field
          var hot = stepHot;
          if (opts.preSteps) {
            fieldIdStr = 'customfield_10400'; // "customfield_10400" seems to be the "Pre-Test Requirements:" field
            hot = preStepHot;
          }
          try {
            if (isLoggedIn) {
              issueStatus.innerHTML = `<br>Getting issue. Please wait...`;
              jira.issue.getIssue({
                  issueKey: key // example PROJECT-25814
              }, function(error, issue, response) {
                  switch (response.statusCode) {
                    case 200: // response.statusMessage: "OK"
                      console.log(issue); console.log(response);
                      if (issue.fields && issue.fields.issuetype && issue.fields.issuetype.name.includes('Test Case')) {
                        issueStatus.innerHTML = `<br>Summary: ${issue.fields.summary}`;
                        /* customfield_10403 is the "Test Case Steps" */
                        arr = convertJiraMarkupToArray(issue.fields[fieldIdStr]);
                        console.log(arr);
                        hot.loadData(arr);
                        gotSteps = true;
                      } else {
                        gotSteps = false;
                        issueStatus.innerHTML = `<br>The issue is not a 'Test Case'`;
                      }
                      break;
                    case 404: // response.statusMessage: "Not Found"
                      gotSteps = false;
                      console.log(error); console.log(response);
                      issueStatus.innerHTML = `<br>Issue Not Found`;
                      break;
                    default: // unexpected
                      gotSteps = false;
                      issueStatus.innerHTML = `<br>Unexpected response from jira. Please see the console for more information (CTRL+SHIFT+I)`;
                      console.log(error); console.log(issue); console.log(response);
                  }
              });
            } else {
              issueStatus.innerHTML = `<br>Please login first`;
            }
          } catch (e) {
            gotSteps = false;
            console.log(e);
            if (!isLoggedIn) {
              issueStatus.innerHTML = `<br>Please login first`;
            } else {
              issueStatus.innerHTML = `<br>Please enter an issue key above`;
            }
          }
        }

        function editSteps(idIssueKey, opts={}) {
          if (!isLoggedIn) {
            updateStatus.innerHTML = `<br>Please login first.`;
            return false;
          }
          var key = document.getElementById(idIssueKey).value;
          var fieldIdStr = 'customfield_10403'; // "customfield_10403" seems to be the "Test Execution Steps and Expected Results:" field
          var hot = stepHot;
          if (opts.preSteps) {
            fieldIdStr = 'customfield_10400'; // "customfield_10400" seems to be the "Pre-Test Requirements:" field
            hot = preStepHot;
          }
          var issueUpdate = {
            "fields" : {  }
          };
          issueUpdate.fields[fieldIdStr] = convertArrayToJiraMarkup(hot.getData());

          try {
            jira.issue.getIssue({issueKey:key}, function(e,i,r) {
              switch (r.statusCode) {
                case 200: // response.statusMessage: "OK"
                  console.log(i); console.log(r);
                  updateStatus.innerHTML = `<br>Updating. Please wait...`;
                  jira.issue.editIssue({
                    issueKey: key,
                    issue: issueUpdate
                  }, function(e, i, r) {
                    switch (r.statusCode) {
                      case 204: // response.statusMessage: "No Content"
                      case 200: // response.statusMessage: "OK"
                        updateStatus.innerHTML = `<br>Done`;
                        break;
                      case 400: // response.statusMessage: "Bad Request"
                        updateStatus.innerHTML = `<br>Error 400 - Bad Request. Please see the console for more information (CTRL+SHIFT+I)`;
                        console.log(e); console.log(i); console.log(r);
                        break;
                      default:
                        updateStatus.innerHTML = `<br>Unexpected response from jira on editIssue. Please see the console for more information (CTRL+SHIFT+I)`;
                        console.log(e); console.log(i); console.log(r);
                    }
                  });
                  break;
                case 404: // response.statusMessage: "Not Found"
                  console.log(e); console.log(r);
                  updateStatus.innerHTML = `<br>Issue Not Found`;
                  break;
                default: // unexpected
                  updateStatus.innerHTML = `<br>Unexpected response from jira on getIssue. Please see the console for more information (CTRL+SHIFT+I)`;
                  console.log(e); console.log(i); console.log(r);
              }
          	});
          } catch(e) {
            console.log(e);
            if (!isLoggedIn) {
              updateStatus.innerHTML = `<br>Please login first.`;
            } else if (!gotSteps) {
              updateStatus.innerHTML = `<br>Please get steps from Jira via the 'Get Steps' button.`;
            } else {
              updateStatus.innerHTML = `<br>Unexpected problem. Please refresh the page (CTRL+R) and try again.`;
            }
          }
        }
    </script>


    <script type="text/javascript">
      /**
       * I just realized that this lets you insert undefined via the following:
       *   someArray.insert(1) // notice the second param is undefined
       * TODO: make sure this function is safer
       */
      Array.prototype.insert = function ( index, item ) {
          this.splice( index, 0, item );
      };

      /**
       * var array = [2, 5, 9];
       * var index = array.indexOf(5);
       * array.splice(index, 1);
       * // array = [2, 9]
       */
      Array.prototype.remove = function ( index ) {
        if (index > -1) {
          this.splice(index, 1);
          return true;
        }
        else { return false; }
      };


      function convertJiraMarkupToArray(stringMarkup) {
        var first_row = stringMarkup.split(/\r\n|\n/); // just grab the first line
        var rows = stringMarkup.split(/\|\n|\|\t\n|\|\s+\n/g);
        /* if there is a mismatch, then the || is missing and needs fixing */
        if (
          (first_row[0] != rows[0])
          && (first_row[0] != rows[0] + "|")
        ) {
          rows[0] = rows[0].split(/\r\n|\n/);
          rows.insert( 1, rows[0][1] );
          rows[0] = rows[0][0];
          rows[0] = rows[0] + "||";
        }

        var finalArray = [];
        var i = 0;
        var x = 0;
        var longest_row_len = 0;

        /* loop over each row from input
         * and split into finalArray by delimiters
         * "||" or "|"
         */
        rows.forEach(function each(row) {
          const regex = /\|\||\|/;
          console.log(row);
          finalArray[i] = row.split(regex);

          for(x=0; x < finalArray[i].length - 1 ; x++) {
            if (finalArray[i][x][finalArray[i][x].length - 1] == "\\") {
              finalArray[i][x] = finalArray[i][x] + finalArray[i][x+1];
              finalArray[i].remove(x+1);
            }
            if (x == 0) {
              finalArray[i].remove(0);
            }
            finalArray[i][x] = finalArray[i][x].trim();
          }

          currLen = finalArray[i].length;
          longest_row_len = (longest_row_len > currLen) ? longest_row_len : currLen;
          i++;
        });

        /* make sure each row in "finalArray" has length = "longest_row_len"
         * because range.setValues requires the dimensions of "finalArray"
         * to exactly match the specified dimensions.
         */
        var m = 0;
        var n = 0;
        finalArray.forEach(function each(row) {
          currLen = row.length;
          if (longest_row_len > currLen) {
            m = longest_row_len - currLen;
            /* push "" into row 'm' number of times */
            for(n = 0; n < m; n++){
              row.push("");
            }
          }
        });

        return finalArray;

      }

      /* make an 'n' by 'n' array and fill it with 'f'; f can be undefined */
      function makeNbyNArray(n,f) {
      	if (typeof(n) !== 'number') { console.log("please input a number"); return false; }
        return Array(n).fill(f).map(()=>Array(n).fill(f));
      }


      function convertArrayToJiraMarkup(arr) {
        if (!arr || !Array.isArray(arr)) {
          console.error('need input array');
          return false;
        }
        /* declare all local variables */
        var values = arr;
        var i;
        var step;
        var desc;
        var expect;
        var notes;
        var pcnum = 0; /* EC: Defined the precondition number as "0" */
        var stnum = 0; /* EC: Defined the step number as "0" */
        var vpnum = 0; /* EC: Defined the VP number as "0" */
        var out_values = [];

        for (i = 0; i < arr.length; i++) {
            /* EC: read all values as strings to fix the issue when a number is only entered in a cell */
            /* trim gets rid of leading and trailing whitespaces */
            /* replace all tabs with spaces
             * helps prevent the quotation marks showing up after copying
             */
            /* EC: replaces any quotation marks with double-quotation marks so it doesn't break the code */
            step   = (values[i][0]) ? values[i][0].trim().replace(/\t/g," ").replace(/"/g,'""') : "";
            desc   = (values[i][1]) ? values[i][1].trim().replace(/\t/g," ").replace(/"/g,'""') : "";
            expect = (values[i][2]) ? values[i][2].trim().replace(/\t/g," ").replace(/"/g,'""') : "";
            notes  = (values[i][3]) ? values[i][3].trim().replace(/\t/g," ").replace(/"/g,'""') : "";

            /* apply markup characters for bold (b_list) italics (i_list) and underline (u_list) words. */
            /* the single-quote at the front tells Google Sheets to
             * parse cell as plain-text rather than formula */
            // desc   = "'" + textFormatting(desc, b_list, i_list, u_list);
            // expect = "'" + textFormatting(expect, b_list, i_list, u_list);
            // notes  = "'" + textFormatting(notes, b_list, i_list, u_list);

            /* if `step` contains substring "VP" */
            step = step.replace(/vp/i, "VP"); /* EC: replaces any "vp"(case insensitive) with "VP" in any `step` */

            if (i == 0) { /* the header row */
              out_values.push(["||", step, "||", desc, "||", expect, "||", notes, "||"]);
            }
            else if (
              step.indexOf("VP") > -1  /* EC: eliminated unneeded or statements due to previous VP replacement code */
            ) {
              vpnum = vpnum + 1; /* EC: increased VP number by 1 */
              step = "VP " + vpnum; /* require standard naming of step name for VP */
              out_values.push(["||", step, "||", desc, "||", expect, "||", notes, "||"]);
            }
            else {
              step = step.replace(/pc/i, "Precondition");
              step = step.replace(/precondition/i, "Precondition");
              step = step.replace(/step/i, "Step");
              step = step.replace(/quote/i, "Quote");
              if (step.indexOf("Step") > -1) {
                stnum = stnum + 1; /* If `step` contains "Step", increase Step number by 1 */
                step = "Step " + stnum; /* require standard naming of step name for Step */
              }
              else if (step.indexOf("Precondition") > -1) {
                pcnum = pcnum + 1; /* If `step` contains "Precondition", increase Precondition number by 1 */
                step = "Precondition " + pcnum; /* require standard naming of step name for Step */
              }
              else if (step.indexOf("Quote") > -1) {
                /* If `step` contains "Quote", then Step number is same as previous */
                desc = desc.slice(1); /* remove the single-quote at the front because it is not useful when Quote gets inserted into a previous row */
                desc = "\n" + " {quote}" + desc + "{quote}"; /* surround description with quote tags */
                out_values[out_values.length-1][3] += desc; /* append description to last row (index 3 of out_values has description)*/
                continue; /* continue to avoid appending the Quote row to the out_values */
              }
              /* else leave it alone? */
              out_values.push(["|", step, "|", desc, "|", expect, "|", notes, "|"]);
          }
        }

        outputString = "";
        for (i = 0; i < out_values.length; i++) {
          outputString += out_values[i].join(' ');
          outputString += '\n';
        }

        return outputString;
      }

    </script>

    <script type="text/javascript">
        const docx = require("docx");
        const filesaver = require('file-saver');

        const { Document, Paragraph, TextRun, Packer } = docx;
        const { saveAs } = filesaver;

        function generate() {
            console.log('generating docx');
            const doc = new Document();

            const paragraph = new Paragraph();
            var stepHotString = "";
            var arr = stepHot.getData();
            for (i = 0; i < arr.length; i++) {
              stepHotString += arr[i].join(' ');
              stepHotString += '\n';
            }
            const text = new TextRun(stepHotString).tab();
            paragraph.addRun(text);
            doc.addParagraph(paragraph);

            doc.addParagraph(new Paragraph(""));

            var preStepHotString = "";
            var arr = preStepHot.getData();
            for (i = 0; i < arr.length; i++) {
              preStepHotString += arr[i].join(' ');
              preStepHotString += '\n';
            }
            const p2 = new Paragraph();
            const t2 = new TextRun(preStepHotString).tab();
            p2.addRun(t2);


            doc.addParagraph(p2);

            const packer = new Packer();

            packer.toBlob(doc).then(blob => {
                console.log(blob);
                saveAs(blob, "example.docx");
                console.log("Document created successfully");
            });
        }
    </script>

    <script type="text/javascript">
      function foo() {
        console.log('foo');
      }
    </script>

    <button type="button" onclick="generate()">Generate DOCX</button>

  </footer>
</html>
