<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <title>Hello World!</title>
    <link rel="stylesheet" href="./style.css">
    <script src="node_modules/handsontable/dist/handsontable.full.min.js"></script>
    <link href="node_modules/handsontable/dist/handsontable.full.min.css" rel="stylesheet" media="screen">
  </head>
  <body>
    <h1>Hello World!</h1>
    <div>
       <!-- All of the Node.js APIs are available in this renderer process. -->
       We are using Node.js <script>document.write(process.versions.node)</script>,
       Chromium <script>document.write(process.versions.chrome)</script>,
       and Electron <script>document.write(process.versions.electron)</script>.
    </div>

    <script>
      // You can also require other files to run in this process
      require('./renderer.js')
    </script>

    <div><img src="https://gph.to/2lfKbGD" alt="very nice gif borat"></div>

    <br><br>
    <br><br>
    <br><br>


    <div class="login">
      username: <input id="userID" type="text" name="username"><br>
      password: <input id="passID" type="password" name="password"><br>
      <div id="loginStatusContainer"></div>
      <button value="login" onclick="login('userID','passID')">Login</button><br>
    </div>

    <br><br>

    <div class="after_login">

        <div class="issue">
          issue: <input id="issueKey" type="text" name="issue"><br>
          <div id="issueStatusContainer"></div>
          <button value="get test steps" onclick="getIssue('issueKey')">get test steps</button><br>
        </div>

        <br><br>
        <br><br>

        <div>
          <input id="search_field" type="search" placeholder="Search">
          <br><br>
          <div id="sheet"></div>
          <script type="text/javascript">
            var data = [
              ["Step", "Description", "Expected", "Notes"],
              ["Step 1", "do stuff", "expect this", "remember this important thing"],
              ["Step 2", "do stuff", "expect this", ""],
              [,,,],
              [,,,],
              [,,,],
              [,,,],
              [,,,],
            ];

            var container = document.getElementById('sheet');
            var searchFiled = document.getElementById('search_field');

            hotStuff = {
              data: data,
              width: 800,
              rowHeaders: true,
              colHeaders: [
                 'Step',
                 'Description',
                 'Expected',
                 'Notes',
              ],
              colWidths: [60, 200, 200, 200],
              /* true by default */
              allowInsertRow: true, /* even without contextMenu, can paste to expand spreadsheet */
              allowRemoveRow: true,
              /* false by default */
              search: true,
              contextMenu: true,
              mergeCells: true,
              manualRowResize: true,
              manualColumnResize: true,
              wordWrap: true,
              //manualRowMove: true,
              //manualColumnMove: true,
              /* a way to enforce 4 columns Step/Desc/Expect/Notes */
              allowInsertColumn: false,
              allowRemoveColumn: false
            };

            var hot = new Handsontable(container, hotStuff);

            Handsontable.dom.addEvent(searchFiled, 'keyup', function (event) {
              var search = hot.getPlugin('search');
              var queryResult = search.query(this.value);

              console.log(queryResult);
              hot.render();
            });

          </script>
        </div>

        <br><br>

        <div class="update">
          <input type="button" value="update issue">
        </div>

        <br><br>

        <div>
          <title>JSON Jenerator</title>
          <h1>JSON Jenerator:</h1>
          <main>
            <div id="displayContainer"></div>
            <div id="buttonContainer">
              <button type="button" id="generate">Jenerate!</button>
            </div>
          </main>
        </div>

    </div>
  </body>
  <footer>
    <script type="text/javascript">
        // gloabal variables
        process.env.NODE_TLS_REJECT_UNAUTHORIZED = '0';
        user = "";
        pass = "";
        jira = undefined;
        b64 = "";
        const loginStatus = document.querySelector('#loginStatusContainer');
        const issueStatus = document.querySelector('#issueStatusContainer');
        var isLoggedIn = false;

        var JiraClient = require('jira-connector');

        function login(idUserInput, idPassInput) {
          user = document.getElementById(idUserInput).value;
          pass = document.getElementById(idPassInput).value;
          b64 = btoa(user+":"+pass); user="";pass="";
          console.log("logging in...");
          jira = new JiraClient( {
              host: 'jira/jira',
              basic_auth: {
                base64: b64
              }
          });
          loginStatus.innerHTML = `<br>Logging in. Please wait...`;
          jira.myself.getMyself( {}, function(error, myself, response) {
            switch (response.statusCode) {
              case 200: // response.statusMessage: "OK"
                isLoggedIn = true;
                console.log(myself);
                console.log(response);
                loginStatus.innerHTML = `<br>Hello ${myself.displayName}!`;
                break;
              case 401: // response.statusMessage: "Unauthorized"
                isLoggedIn = false;
                console.log(error);
                console.log(response);
                loginStatus.innerHTML = `<br>Wrong username/password`;
                break;
              case 403: // response.statusMessage: "Forbidden"
                isLoggedIn = false;
                console.log(error);
                console.log(response);
                /* in the future check `response.headers.x-authentication-denied-reason`
                 * if it has "CAPTCHA_CHALLENGE"
                 * then use the information inside `response` to redirect to the CAPTCHA via the login-url & JSESSIONID
                 */
                loginStatus.innerHTML = `<br>Your account is locked.`
                    + `<br>Please contact to your administrator to unlock your account and/or do the CAPTCHA on https://${jira.host}`;
                break;
              default: // unexpected
                isLoggedIn = false;
                loginStatus.innerHTML = `<br>Unexpected response from jira. Please see the console for more information (CTRL+SHIFT+I)`;
                console.log(error);
                console.log(myself);
                console.log(response);
            }
          });
        }

        var arr;

        function getIssue(idIssueKey) {
          key = document.getElementById(idIssueKey).value;
          jira.issue.getIssue({
              issueKey: key
          }, function(error, issue, response) {
              switch (response.statusCode) {
                case 200: // response.statusMessage: "OK"
                  console.log(issue);
                  console.log(response);
                  issueStatus.innerHTML = `<br>Summary: ${issue.fields.summary}`;
                  /* customfield_10403 is the "Test Case Steps" */
                  arr = convertJiraMarkupToArray(issue.fields.customfield_10403);
                  console.log(arr);
                  hot.loadData(arr);
                  break;
                case 404: // response.statusMessage: "Not Found"
                  console.log(error);
                  console.log(response);
                  issueStatus.innerHTML = `<br>Issue Not Found`;
                  break;
                default: // unexpected
                  issueStatus.innerHTML = `<br>Unexpected response from jira. Please see the console for more information (CTRL+SHIFT+I)`;
                  console.log(error);
                  console.log(issue);
                  console.log(response);
              }
          });
        }

        //======================================================

        function getMyself(){
          jira.myself.getMyself( {}, function(error, myself, response) {
              console.log(error);
              console.log(myself);
          });
        };


        function get_gold_25814() {
          jira.issue.getIssue({
              issueKey: 'GOLD-25814'
          }, function(error, issue) {
              console.log(error);
              console.log(issue.fields.summary);
              console.log(issue);
              /* customfield_10403 is the "Test Case Steps" */
              display.innerHTML = `<pre>${issue.fields.customfield_10403}</pre>`;
              display.innerHTML += `<br><br>${issue.key} : ${issue.fields.summary}!`;
              data = convertJiraMarkupToArray(issue.fields.customfield_10403);
              changeButton();
          });
        }
        //======================================================

        const jsonButton = document.querySelector('#generate');
        const buttonContainer = document.querySelector('#buttonContainer');
        const display = document.querySelector('#displayContainer');
        const collection = ["Another", "More", "Next", "Continue", "Keep going", "Click me", "A new one"];

        const generateJson = () => {
          const xhr = new XMLHttpRequest();
          xhr.responseType = 'json';

          xhr.onreadystatechange = () => {
            if (xhr.readyState === XMLHttpRequest.DONE) {
              display.innerHTML = `<pre>${JSON.stringify(xhr.response)}</pre>`;
              display.innerHTML += `<br><br>Hello ${xhr.response.displayName}!`;
              changeButton();
            }
          }
          xhr.open('GET', 'https://jira/jira/rest/api/latest/myself');
          console.log("attempt authorization with user: " + user);
          xhr.setRequestHeader("Authorization", "Basic " + b64);
          xhr.send();
        }

        const changeButton = () => {
          const newText = Math.floor(Math.random() * 7);
          jsonButton.innerHTML = `${collection[newText]}!`;
        }

        jsonButton.addEventListener('click', generateJson);
    </script>


    <script type="text/javascript">
      /**
       * I just realized that this lets you insert undefined via the following:
       *   someArray.insert(1) // notice the second param is undefined
       * TODO: make sure this function is safer
       */
      Array.prototype.insert = function ( index, item ) {
          this.splice( index, 0, item );
      };

      /**
       * var array = [2, 5, 9];
       * var index = array.indexOf(5);
       * array.splice(index, 1);
       * // array = [2, 9]
       */
      Array.prototype.remove = function ( index ) {
        if (index > -1) {
          this.splice(index, 1);
          return true;
        }
        else { return false; }
      };


      function convertJiraMarkupToArray(stringMarkup) {
        var first_row = stringMarkup.split(/\r\n|\n/); // just grab the first line
        var rows = stringMarkup.split(/\|\n|\|\t\n|\|\s+\n/g);
        /* if there is a mismatch, then the || is missing and needs fixing */
        if (
          (first_row[0] != rows[0])
          && (first_row[0] != rows[0] + "|")
        ) {
          rows[0] = rows[0].split(/\r\n|\n/);
          rows.insert( 1, rows[0][1] );
          rows[0] = rows[0][0];
          rows[0] = rows[0] + "||";
        }

        var finalArray = [];
        var i = 0;
        var x = 0;
        var longest_row_len = 0;

        /* loop over each row from input
         * and split into finalArray by delimiters
         * "||" or "|"
         */
        rows.forEach(function each(row) {
          const regex = /\|\||\|/;
          console.log(row);
          finalArray[i] = row.split(regex);

          for(x=0; x < finalArray[i].length - 1 ; x++) {
            if (finalArray[i][x][finalArray[i][x].length - 1] == "\\") {
              finalArray[i][x] = finalArray[i][x] + finalArray[i][x+1];
              finalArray[i].remove(x+1);
            }
            if (x == 0) {
              finalArray[i].remove(0);
            }
            finalArray[i][x] = finalArray[i][x].trim();
          }

          currLen = finalArray[i].length;
          longest_row_len = (longest_row_len > currLen) ? longest_row_len : currLen;
          i++;
        });

        /* make sure each row in "finalArray" has length = "longest_row_len"
         * because range.setValues requires the dimensions of "finalArray"
         * to exactly match the specified dimensions.
         */
        var m = 0;
        var n = 0;
        finalArray.forEach(function each(row) {
          currLen = row.length;
          if (longest_row_len > currLen) {
            m = longest_row_len - currLen;
            /* push "" into row 'm' number of times */
            for(n = 0; n < m; n++){
              row.push("");
            }
          }
        });

        return finalArray;

      }

      /* make an 'n' by 'n' array and fill it with 'f'; f can be undefined */
      function makeNbyNArray(n,f) {
      	if (typeof(n) !== 'number') { console.log("please input a number"); return false; }
        return Array(n).fill(f).map(()=>Array(n).fill(f));
      }
    </script>
  </footer>
</html>
